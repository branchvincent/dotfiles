#!/bin/bash

[ -z "${DIRENV_DEBUG:-}" ] || set -x

# Copy of stdlib's `__dump_at_exit`, but logs on failure
# https://github.com/direnv/direnv/issues/893
__my_dump_at_exit() {
    local ret=$?
    [[ $ret == 0 ]] || echo -e "\033[31mDIRENV FAILED! To debug: export DIRENV_DEBUG=1\033[0m" >&2
    # shellcheck disable=SC2154
    "$direnv" dump json "" >&3
    trap - EXIT
    exit "$ret"
}
trap __my_dump_at_exit EXIT

# Usage: layout auto
#
# Detects and loads project based on file structure
layout_auto() {
    log_status "detecting layout"
    if [[ -f go.mod ]]; then
        log_status "detected go project"
        use go
        layout go
    elif [[ -f package.json ]]; then
        log_status "detected node project"
        use nodejs
        layout nodejs
    elif [[ -f poetry.lock ]]; then
        log_status "detected poetry project"
        use python
        layout poetry
    elif [[ -f pdm.lock ]]; then
        log_status "detected pdm project"
        layout pdm
    elif [[ -f pyproject.toml ]]; then
        log_status "detected python project"
        use python
        layout python
    fi
    dotenv_if_exists
}

### Go ###

# Usage: use go [<version>]
use_go() {
    version=$(parse_version go.mod 'go[[:space:]](.*)' "$@")
    use_tea +go.dev"$version"
}

layout_go() {
    export GOBIN="$PWD/bin"
    PATH_add bin
}

### Node ###

# Usage: use nodejs [<version>]
use_nodejs() {
    version=$(parse_version .nvmrc '(.*)' "$@")
    use_tea +nodejs.org"$version" +npmjs.com
}

layout_nodejs() {
    PATH_add node_modules/.bin

    # Install, if deps are outdated
    if [[ -f package-lock.json && package-lock.json -nt node_modules/.package-lock.json ]]; then
        npm install
    elif [[ -f yarn.lock && yarn.lock -nt node_modules ]]; then
        yarn install
    fi
    watch_file package-lock.json yarn.lock
}

### Python ###

# Usage: use python [<version>]
use_python() {
    version=$(parse_version .python-version '(.*)' "$@")
    use_tea +python.org"$version" +pip.pypa.io
}

layout_python() {
    # Activate venv
    export VIRTUAL_ENV="$PWD/.venv"
    export PIP_PYTHON="$VIRTUAL_ENV/bin/python"
    PATH_add "$VIRTUAL_ENV/bin"

    # Install
    if [[ ! -d "$VIRTUAL_ENV" ]]; then
        python3 -m venv "$VIRTUAL_ENV" --without-pip
        pip3 install -e .
    fi
}

layout_poetry() {
    # Install, if deps are outdated
    if [[ ! -d .venv || poetry.lock -nt "$(echo .venv/lib/python*/site-packages)" ]]; then
        poetry install
    fi
    watch_file poetry.lock

    # Activate venv
    export VIRTUAL_ENV="$PWD/.venv"
    export PIP_PYTHON="$VIRTUAL_ENV/bin/python"
    export POETRY_ACTIVE=1
    PATH_add "$VIRTUAL_ENV/bin"
}

layout_pdm() {
    # Install, if deps are outdated
    if [[ ! -d __pypackages__ || pdm.lock -nt "$(echo __pypackages__/*/lib)" ]]; then
        pdm install
    fi
    watch_file pdm.lock

    # Activate PEP 582 (faster equivalent to `pdm --pep582`)
    path_add PYTHONPATH "$HOMEBREW_PREFIX"/opt/pdm/libexec/lib/python*/site-packages/pdm/pep582
    PATH_add "$PWD"/__pypackages__/*/bin
}

### Tea ###

# Usage: parse_version <filename> <regex> [version]
#
# Returns a version constraint for tea, constructed from either the given version or file
parse_version() {
    version_file=$1
    version_regex=$2
    version=${3:-any}
    via=".envrc"

    if [[ "$version" = "any" && -f "$version_file" && $(<"$version_file") =~ $version_regex ]]; then
        version=${BASH_REMATCH[1]}
        via="$version_file"
    fi

    log_status "resolved version $version (via $via)"
    watch_file "$version_file"
    [[ "$version" = "any" ]] || echo "~${version#v}"
}

# Usage: use tea [<pkg> ...]
#
# Loads the given packages or falls back to .tea-versions
use_tea() {
    if (($#)); then
        eval "$("$direnv" dotenv bash <(SHELL=bash tea "$@"))"
    elif [[ -f .tea-versions ]]; then
        args=$(sed '/^[^+]/ s/^/+/' .tea-versions | tr '\n' ' ')
        # shellcheck disable=SC2086
        eval "$("$direnv" dotenv bash <(SHELL=bash tea $args))"
    else
        eval "$(SHELL=bash tea --env --keep-going --silent --dry-run=w/trace)"
    fi
}

### Main ###

if [[ ! -s .envrc ]]; then # empty .envrc
    layout auto
fi
