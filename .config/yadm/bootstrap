#!/bin/bash
#
# Bootstraps the machine by sourcing all scripts in ./bootstrap.d/

set -euo pipefail
[ -n "${DEBUG:-}" ] && set -x

bold='\e[1;39m'
cyan='\e[36m'
green='\e[32m'
white='\e[37m'
yellow='\e[33m'
reset='\e[0m'

has() { command -v "$1" &>/dev/null; }
interactive() { [ -z "${NONINTERACTIVE:-}" ] && [ -t 0 ]; }
debug() { printf "${green}[bootstrap]${reset} %s...\n" "$@"; }
debugw() { printf "${yellow}[bootstrap]${reset} %s!\n" "$@"; }
log() { printf "${bold}${green}==>${white} %s${reset}\n" "$@"; }
logw() { printf "${bold}${yellow}==>${white} %s${reset}\n" "$@"; }

ask() {
    interactive || return 0
    # shellcheck disable=SC2059
    printf "$1"
    read -rn1
    printf "\e[2K\r" # clear line
}

log "Running bootstrap"

if ! yadm gitconfig local.class &>/dev/null; then
    ask "Is this your ${bold}${cyan}(1) home${reset} or ${bold}${cyan}(2) work${reset} computer? (1/2/n)"
    case "${REPLY:-}" in
    1) yadm gitconfig local.class Home ;;
    2) yadm gitconfig local.class Work ;;
    *) yadm gitconfig local.class Default ;;
    esac
fi

# shellcheck disable=SC2034
YADM_CLASS=$(yadm gitconfig local.class | tail -1)

for file in "$0.d"/*.sh; do
    [[ $file =~ "##" ]] && continue
    filename=$(basename "${file%.sh}")

    # Allow skipping certain scripts
    ask "Configure ${bold}${white}${filename}${reset}? (y/n)"
    if [[ ! "${REPLY:-}" =~ ^[Yy]?$ ]]; then
        logw "Skipping $filename"
        continue
    fi

    log "Configuring $filename"
    # shellcheck source=/dev/null
    source "$file"
    echo
done

log "Bootstrap done! Entering fish..."

if has fish; then
    exec fish -il
fi
